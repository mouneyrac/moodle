YUI.add("moodle-assignfeedback_editpdf-editor",function(e,t){var n=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",r={DIALOGUE:"assignfeedback_editpdf_widget"},i={PREVIOUSBUTTON:"."+r.DIALOGUE+" .navigate-previous-button",NEXTBUTTON:"."+r.DIALOGUE+" .navigate-next-button",PAGESELECT:"."+r.DIALOGUE+" .navigate-page-select",LOADINGICON:"."+r.DIALOGUE+" .loading",DRAWINGREGION:"."+r.DIALOGUE+" .drawingregion",DRAWINGCANVAS:"."+r.DIALOGUE+" .drawingcanvas",CANCEL:"."+r.DIALOGUE+" .cancelbutton",SAVE:"."+r.DIALOGUE+" .savebutton",COLOURBUTTON:"."+r.DIALOGUE+" .pdfbutton_colour",DIALOGUE:"."+r.DIALOGUE},s={red:"rgb(255,176,176)",green:"rgb(176,255,176)",blue:"rgb(208,208,255)",white:"rgb(255,255,255)",yellow:"rgb(255,255,176)"},o=300,u={comment:"."+r.DIALOGUE+" .pdfbutton_comment",pen:"."+r.DIALOGUE+" .pdfbutton_pen",line:"."+r.DIALOGUE+" .pdfbutton_line",rectangle:"."+r.DIALOGUE+" .pdfbutton_rectangle",oval:"."+r.DIALOGUE+" .pdfbutton_oval",stamp:"."+r.DIALOGUE+" .pdfbutton_stamp",eraser:"."+r.DIALOGUE+" .pdfbutton_eraser"},a=4;Drawable=function(){this.shapes=[],this.nodes=[]},EDITOR=function(){EDITOR.superclass.constructor.apply(this,arguments)},EDITOR.prototype={dialogue:null,pagecount:0,currentpage:0,pages:[],loadingicon:null,pageimage:null,graphic:null,currentcolour:"yellow",currenttool:"comment",currentedit:{},currentdrawable:!1,drawables:[],colourpicker:null,initializer:function(){var t,n;t=e.one("#"+this.get("linkid")),t.on("click",this.link_handler,this),t.on("key",this.link_handler,"down:13",this),n=e.one("#"+this.get("deletelinkid")),n.on("click",this.delete_link_handler,this),n.on("key",this.delete_link_handler,"down:13",this),this.currentedit.start=!1,this.currentedit.end=!1},link_handler:function(t){var n;t.preventDefault(),this.dialogue?this.dialogue.show():(this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),width:"840px",visible:!0}),this.dialogue.centerDialogue(),this.dialogue.get("boundingBox").addClass(r.DIALOGUE),this.loadingicon=e.one(i.LOADINGICON),n=e.one(i.DRAWINGCANVAS),this.graphic=new e.Graphic({render:i.DRAWINGCANVAS}),n.on("mousedown",this.edit_start,this),n.on("mousemove",this.edit_move,this),n.on("mouseup",this.edit_end,this)),this.load_all_pages()},delete_link_handler:function(t){var r,i;t.preventDefault();var s=n,o;o={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"deletefeedbackdocument",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(){r=e.one("#"+this.get("downloadlinkid")),i=e.one("#"+this.get("deletelinkid")),r.addClass("hidden"),i.addClass("hidden")},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(s,o)},load_all_pages:function(){var t=n,r;r={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadallpages",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(e,t){this.all_pages_loaded(t.responseText)},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(t,r)},all_pages_loaded:function(t){var n;try{n=e.JSON.parse(t)}catch(r){return this.dialogue.hide(),new M.core.exception(r)}this.pagecount=n.pagecount,this.pages=n.pages,this.setup_navigation(),this.change_page(),this.setup_save_cancel(),this.setup_toolbar()},setup_toolbar:function(){e.each(u,function(t,n){var r=e.one(t);r.on("click",this.handle_toolbutton,this,n),r.on("key",this.handle_toolbutton,"down:13",this,n),r.setAttribute("aria-pressed","false")},this);var t=e.one(u[this.currenttool]);t.addClass("selectedbutton"),t.setAttribute("aria-pressed","true");var n=e.one(i.COLOURBUTTON);n.on("click",this.handle_colourbutton,this),n.on("key",this.handle_colourbutton,"down:13",this),n.setAttribute("title",this.currentcolour+"color");var r="";e.each(s,function(e,t){r=r+'<div class="square '+t+'" title="'+t+'" role="button" tabIndex=0></div>'},this),this.colourpicker||(this.colourpicker=new M.core.dialogue({width:307,extraClasses:["colourpicker"],draggable:!1,center:!1,lightbox:!1,headerContent:M.util.get_string("colourpicker","assignfeedback_editpdf"),bodyContent:'<div id="colorpicker" class="" style="">'+r+"</div>",footerContent:"",zIndex:6e4}))},handle_colourbutton:function(t){t.preventDefault(),this.colourpicker.show(),this.colourpicker.render();var n=e.one(i.COLOURBUTTON).getXY(),r=e.one(".moodle-dialogue-base .colourpicker").getXY();this.colourpicker.move(r[0],n[1]+40),e.each(s,function(t,n){e.one("."+n).on("click",this.changecolor,null,n,this,this.colourpicker)},this),e.on("click",e.bind(this.colourpicker.show,this.colourpicker),e.one(i.COLOURBUTTON)),e.one(document).on("click",function(t,n){var r=e.one(i.COLOURBUTTON).get("childNodes");t.target.ancestor("#colorpicker")===null&&t.target.get("id")!=r.item(0).get("id")&&t.target.get("id")!=e.one(i.COLOURBUTTON).get("id")&&n.get("visible")==1&&n.hide()},null,this.colourpicker),e.one(".colourpicker").get("childNodes").item(0).setAttribute("tabIndex","-1"),e.one(".colourpicker").get("childNodes").item(0).focus()},handle_toolbutton:function(t,n){t.preventDefault();var r=e.one(u[this.currenttool]);r.removeClass("selectedbutton"),r.setAttribute("aria-pressed","false");var i=e.one(u[n]);i.addClass("selectedbutton"),i.setAttribute("aria-pressed","true"),this.currenttool=n},changecolor:function(t,n,r,s){var o=M.cfg.wwwroot+"/theme/image.php?theme=standard&component=assignfeedback_editpdf&image=";e.one(".pdfbutton_colour").get("childNodes").item(0).setAttribute("src",o+n),r.currentcolour=n;var u=e.one(i.COLOURBUTTON);u.setAttribute("title",n+"color"),s.hide(),u.focus()},setup_save_cancel:function(){var t=e.one(i.CANCEL),n=e.one(i.SAVE);t.on("mousedown",this.handle_cancel,this),t.on("key",this.handle_cancel,"down:13",this),t.removeAttribute("disabled"),n.on("mousedown",this.handle_save,this),n.on("key",this.handle_save,"down:13",this),n.removeAttribute("disabled"
)},handle_cancel:function(e){e.preventDefault(),this.dialogue.hide()},stringify_pages:function(){var t,n;for(t=0;t<this.pages.length;t++){for(n=0;n<this.pages[t].comments.length;n++)delete this.pages[t].comments[n].drawable;for(n=0;n<this.pages[t].annotations.length;n++)delete this.pages[t].annotations[n].drawable}return e.JSON.stringify(this.pages)},handle_save:function(t){t.preventDefault();var r=n,i;i={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"saveallpages",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),pages:this.stringify_pages()},on:{success:function(t,n){var r,i,s,o;try{r=e.JSON.parse(n.responseText);if(r.error)return new M.core.ajaxException(r);r.url&&(i=e.one("#"+this.get("downloadlinkid")),o=e.one("#"+this.get("downloadlinkid")+" span"),s=e.one("#"+this.get("deletelinkid")),o.setHTML(r.filename),i.setAttribute("href",r.url),i.removeClass("hidden"),s.removeClass("hidden")),this.dialogue.hide()}catch(u){return new M.core.exception(u)}},failure:function(e,t){return M.core.exception(t.responseText)}}},e.io(r,i)},edit_start:function(t){var n=e.one(i.DRAWINGCANVAS).getXY(),r=document.body.scrollTop,s=document.body.scrollLeft,o={x:t.clientX-n[0]+s,y:t.clientY-n[1]+r};if(this.currentedit.starttime)return;this.currentedit.starttime=(new Date).getTime(),this.currentedit.start=o,this.currentedit.end={x:o.x,y:o.y}},get_current_drawable:function(){var t=new Drawable,n,r,i,o,u;if(!this.currentedit.start||!this.currentedit.end)return!1;if(this.currenttool==="comment"||this.currenttool==="rectangle"||this.currenttool==="oval")o=this.currentedit.start.x,this.currentedit.end.x>o?r=this.currentedit.end.x-o:(o=this.currentedit.end.x,r=this.currentedit.start.x-o),u=this.currentedit.start.y,this.currentedit.end.y>u?i=this.currentedit.end.y-u:(u=this.currentedit.end.y,i=this.currentedit.start.y-u);this.currenttool==="comment"&&(n=this.graphic.addShape({type:e.Rect,width:r,height:i,fill:{color:s[this.currentcolour]},x:o,y:u})),this.currenttool==="line"&&(n=this.graphic.addShape({type:e.Path,fill:{color:s[this.currentcolour]},stroke:{weight:a,color:s[this.currentcolour]}}),n.moveTo(this.currentedit.start.x,this.currentedit.start.y),n.lineTo(this.currentedit.end.x,this.currentedit.end.y),n.end());if(this.currenttool==="rectangle"||this.currenttool==="oval")this.currenttool==="rectangle"&&(tooltype=e.Rect),this.currenttool==="oval"&&(tooltype=e.Ellipse),n=this.graphic.addShape({type:tooltype,width:r,height:i,stroke:{weight:a,color:s[this.currentcolour]},x:o,y:u});return t.shapes.push(n),t},erase_drawable:function(e){if(e.shapes)while(e.shapes.length>0)this.graphic.removeShape(e.shapes.pop());if(e.nodes)while(e.nodes.length>0)e.nodes.pop().remove()},redraw_current_edit:function(){this.currentdrawable&&this.erase_drawable(this.currentdrawable),this.currentdrawable=this.get_current_drawable()},edit_move:function(t){var n=e.one(i.DRAWINGCANVAS).getXY(),r=document.body.scrollTop,s=document.body.scrollLeft,o={x:t.clientX-n[0]+s,y:t.clientY-n[1]+r};this.currentedit.start&&(this.currentedit.end=o,this.redraw_current_edit())},edit_end:function(){var e,t,n,r,i,s;s=(new Date).getTime()-this.currentedit.start;if(s<o)return;this.currenttool==="comment"?(t<100&&(t=100),r=this.currentedit.start.x,this.currentedit.end.x>r?t=this.currentedit.end.x-r:(r=this.currentedit.end.x,t=this.currentedit.start.x-r),i=this.currentedit.start.y,this.currentedit.end.y>i?n=this.currentedit.end.y-i:(i=this.currentedit.end.y,n=this.currentedit.start.y-i),e={gradeid:this.get("gradeid"),x:r,y:i,width:t,rawtext:"",pageno:this.currentpage,colour:this.currentcolour},this.pages[this.currentpage].comments.push(e),this.drawables.push(this.draw_comment(e)),this.erase_drawable(this.currentdrawable)):(this.currenttool==="line"?tooltype="line":this.currenttool==="rectangle"?tooltype="rectangle":this.currenttool==="oval"&&(tooltype="oval"),e={gradeid:this.get("gradeid"),x:this.currentedit.start.x,y:this.currentedit.start.y,endx:this.currentedit.end.x,endy:this.currentedit.end.y,type:tooltype,pageno:this.currentpage,colour:this.currentcolour},this.pages[this.currentpage].annotations.push(e)),this.currentedit.starttime=0,this.currentedit.start=!1,this.currentedit.end=!1,this.currentdrawable=!1},draw_annotation:function(t){var n=new Drawable;t.type==="line"&&(shape=this.graphic.addShape({type:e.Path,fill:{color:s[t.colour]},stroke:{weight:a,color:s[t.colour]}}),shape.moveTo(t.x,t.y),shape.lineTo(t.endx,t.endy),shape.end());if(t.type==="rectangle"||t.type==="oval"){var r,i,o,u,f;t.type==="rectangle"&&(f=e.Rect),t.type==="oval"&&(f=e.Ellipse),t.x=parseInt(t.x),t.y=parseInt(t.y),t.endx=parseInt(t.endx),t.endy=parseInt(t.endy),o=t.x,t.endx>o?r=t.endx-o:(o=t.endx,r=t.x-o),u=t.y,t.endy>u?i=t.endy-u:(u=t.endy,i=t.y-u),shape=this.graphic.addShape({type:f,width:r,height:i,stroke:{weight:a,color:s[t.colour]},x:o,y:u})}return n.shapes.push(shape),n},delete_comment:function(e){var t=0,n;n=this.pages[this.currentpage].comments;for(t=0;t<n.length;t++)if(n[t]===e){n.splice(t,1),this.erase_drawable(e.drawable);return}},draw_comment:function(t){var n=new Drawable,r,o=e.one(i.DRAWINGREGION),u=e.one(i.DRAWINGCANVAS).getXY(),a=e.one(i.DIALOGUE).getXY(),f=u[0]-a[0],l=u[1]-a[1];return r=e.Node.create("<textarea/>"),t.width<60&&(t.width=60),r.setStyles({position:"absolute",left:parseInt(t.x,10)+f+"px",top:parseInt(t.y,10)+l+"px",width:t.width+"px",backgroundColor:s[t.colour],color:"black",border:"2px solid black",fontSize:"12pt",fontFamily:"helvetica",minHeight:"1.2em"}),o.append(r),n.nodes.push(r),r.set("value",t.rawtext),r.on("blur",function(){t.rawtext=r.get("value"),t.width=parseInt(r.getStyle("width"),10),t.rawtext.replace(/^\s+|\s+$/g,"")===""&&this.delete_comment(t)},this),t.drawable=n,n},redraw:function(){var e,t;t=this.pages[this.currentpage];while(this.drawables.length>0)this.erase_drawable(this.drawables.pop());for(e=0;e<t.annotations.length;e++)this.drawables.push(this.draw_annotation
(t.annotations[e]));for(e=0;e<t.comments.length;e++)this.drawables.push(this.draw_comment(t.comments[e]))},change_page:function(){var t=e.one(i.DRAWINGCANVAS),n;n=this.pages[this.currentpage],this.loadingicon.hide(),t.setStyle("backgroundImage",'url("'+n.url+'")'),this.redraw()},setup_navigation:function(){var t,n,r,s,o;n=e.one(i.PREVIOUSBUTTON),r=e.one(i.NEXTBUTTON),t=e.one(i.PAGESELECT),this.currentpage>0?n.removeAttribute("disabled"):n.setAttribute("disabled","true"),this.currentpage<this.pagecount-1?r.removeAttribute("disabled"):r.setAttribute("disabled","true"),options=t.all("option");if(options.size()<=1)for(s=0;s<this.pages.length;s++)o=e.Node.create("<option/>"),o.setAttribute("value",s),o.setHTML(s+1),t.append(o);t.removeAttribute("disabled")}},e.extend(EDITOR,e.Base,EDITOR.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:e.Lang.isInteger,value:0},assignmentid:{validator:e.Lang.isInteger,value:0},attemptnumber:{validator:e.Lang.isInteger,value:0},header:{validator:e.Lang.isString,value:""},body:{validator:e.Lang.isString,value:""},footer:{validator:e.Lang.isString,value:""},linkid:{validator:e.Lang.isString,value:""},deletelinkid:{validator:e.Lang.isString,value:""},downloadlinkid:{validator:e.Lang.isString,value:""}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{},M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(e){return new EDITOR(e)}},"@VERSION@",{requires:["base","event","node","io","graphics","json","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-exception","moodle-core-notification-ajaxexception"]});
